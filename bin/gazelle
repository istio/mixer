#!/bin/bash

set -ex

# Remove the symbolic link of generated pb.go files and .gen.go files
# to prevent gazelle from creating wrong go_proto_library.
find . -type l \( -name '*.pb.go' -o -name '*.gen.go' \) | xargs rm -f

bazel run //:gazelle

if [[ "$OSTYPE" == "darwin"* ]]; then
  params=(-i "")
else
  params=(-i)
fi

# Sed to rename some dependencies which are different from the autogenerated
# ones.
# Also this removes the line of "importpath", which seems to be added
# automatically by gazelle to all of go_library/go_binary/go_test rules.
# Mixer rules don't need this.
find . -type f \( -name BUILD -o -name BUILD.bazel \) -print0 | \
    xargs -0 sed "${params[@]}" \
          -e 's|google/rpc:go_default_library|:google/rpc|g' \
          -e 's|@io_istio_api//mixer/v1/config/descriptor:go_default_library|@io_istio_api//:mixer/v1/config/descriptor|g' \
          -e 's|@io_istio_api//mixer/v1:go_default_library|@io_istio_api//:mixer/v1|g' \
          -e 's|@io_istio_api//mixer/v1/template:go_default_library|@io_istio_api//:mixer/v1/template|g' \
          -e '/importpath =/d'
