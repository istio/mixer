// Copyright 2017 Istio Authors
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

// THIS FILE IS AUTOMATICALLY GENERATED.

package bootstrapTemplateTest

import (
	"context"

	"github.com/gogo/protobuf/types"

	"istio.io/mixer/pkg/adapter"

	"istio.io/mixer/template/list"

	"istio.io/mixer/template/quota"

	"istio.io/mixer/template/log"
)

var _ istio_mixer_template_list.HandlerBuilder = builder{}
var _ istio_mixer_template_list.Handler = handler{}

var _ istio_mixer_template_quota.HandlerBuilder = builder{}
var _ istio_mixer_template_quota.Handler = handler{}

var _ istio_mixer_template_log.HandlerBuilder = builder{}
var _ istio_mixer_template_log.Handler = handler{}

type (
	// Adapter is a fake Adapter. It is used for controlling the Adapter's behavior as well as
	// inspect the input values that adapter receives from Mixer
	Adapter struct {
		Behavior    AdapterBehavior
		BuilderData *builderData
		HandlerData *handlerData
	}

	// AdapterBehavior defines the behavior of the Adapter
	// nolint: aligncheck
	AdapterBehavior struct {
		Name    string
		Tmpls   []string
		Builder BuilderBehavior
		Handler HandlerBehavior
	}

	// nolint: aligncheck
	builder struct {
		behavior        BuilderBehavior
		handlerBehavior HandlerBehavior
		data            *builderData
		handlerData     *handlerData
	}

	handler struct {
		behavior HandlerBehavior
		data     *handlerData
	}

	// HandlerBehavior defines the behavior of the Handler
	// nolint: aligncheck
	HandlerBehavior struct {
		HandleListErr   error
		HandleListPanic bool

		HandleListResult adapter.CheckResult

		HandleQuotaErr   error
		HandleQuotaPanic bool

		HandleQuotaResult adapter.QuotaResult

		HandleLogErr   error
		HandleLogPanic bool

		CloseErr   error
		ClosePanic bool
	}

	// BuilderBehavior defines the behavior of the Builder
	// nolint: aligncheck
	BuilderBehavior struct {
		SetListTypesPanic bool

		SetQuotaTypesPanic bool

		SetLogTypesPanic bool

		SetAdapterConfigPanic bool

		ValidateErr   *adapter.ConfigErrors
		ValidatePanic bool

		BuildErr   error
		BuildPanic bool
	}

	handlerData struct {
		HandleListInstances *istio_mixer_template_list.Instance

		HandleListCount int

		HandleQuotaInstances *istio_mixer_template_quota.Instance
		HandleQuotaQuotaArgs adapter.QuotaArgs

		HandleQuotaCount int

		HandleLogInstances []*istio_mixer_template_log.Instance

		HandleLogCount int

		CloseCount int
	}

	builderData struct {
		SetListTypesCount int
		SetListTypesTypes map[string]*istio_mixer_template_list.Type

		SetQuotaTypesCount int
		SetQuotaTypesTypes map[string]*istio_mixer_template_quota.Type

		SetLogTypesCount int
		SetLogTypesTypes map[string]*istio_mixer_template_log.Type

		SetAdapterConfigAdptCfg adapter.Config
		SetAdapterConfigCount   int

		ValidateCount int

		BuildCount int
		BuildCtx   context.Context
		BuildEnv   adapter.Env
	}
)

func (b builder) Build(ctx context.Context, env adapter.Env) (adapter.Handler, error) {
	b.data.BuildCount++
	if b.behavior.BuildPanic {
		panic("Build")
	}

	b.data.BuildCtx = ctx
	b.data.BuildEnv = env

	return handler{behavior: b.handlerBehavior, data: b.handlerData}, b.behavior.BuildErr
}

func (b builder) SetAdapterConfig(cfg adapter.Config) {
	b.data.SetAdapterConfigCount++
	b.data.SetAdapterConfigAdptCfg = cfg

	if b.behavior.SetAdapterConfigPanic {
		panic("SetAdapterConfig")
	}
}

func (b builder) Validate() *adapter.ConfigErrors {
	b.data.ValidateCount++
	if b.behavior.ValidatePanic {
		panic("Validate")
	}

	return b.behavior.ValidateErr
}

func (h handler) Close() error {
	h.data.CloseCount++
	if h.behavior.ClosePanic {
		panic("Close")
	}

	return h.behavior.CloseErr
}

// NewSpyAdapter returns a new instance of Adapter with the given behavior
func NewSpyAdapter(b AdapterBehavior) *Adapter {
	return &Adapter{Behavior: b, BuilderData: &builderData{}, HandlerData: &handlerData{}}
}

func (b builder) SetListTypes(typeParams map[string]*istio_mixer_template_list.Type) {
	b.data.SetListTypesCount++
	b.data.SetListTypesTypes = typeParams

	if b.behavior.SetListTypesPanic {
		panic("SetListTypes")
	}
}

func (h handler) HandleList(ctx context.Context, instance *istio_mixer_template_list.Instance) (adapter.CheckResult, error) {
	h.data.HandleListCount++
	if h.behavior.HandleListPanic {
		panic("HandleList")
	}

	h.data.HandleListInstances = instance
	return h.behavior.HandleListResult, h.behavior.HandleListErr
}

func (b builder) SetQuotaTypes(typeParams map[string]*istio_mixer_template_quota.Type) {
	b.data.SetQuotaTypesCount++
	b.data.SetQuotaTypesTypes = typeParams

	if b.behavior.SetQuotaTypesPanic {
		panic("SetQuotaTypes")
	}
}

func (h handler) HandleQuota(ctx context.Context, instance *istio_mixer_template_quota.Instance,
	quotaArgs adapter.QuotaArgs) (adapter.QuotaResult, error) {
	h.data.HandleQuotaCount++
	if h.behavior.HandleQuotaPanic {
		panic("HandleQuota")
	}

	h.data.HandleQuotaInstances = instance
	h.data.HandleQuotaQuotaArgs = quotaArgs
	return h.behavior.HandleQuotaResult, h.behavior.HandleQuotaErr
}

func (b builder) SetLogTypes(typeParams map[string]*istio_mixer_template_log.Type) {
	b.data.SetLogTypesCount++
	b.data.SetLogTypesTypes = typeParams

	if b.behavior.SetLogTypesPanic {
		panic("SetLogTypes")
	}
}

func (h handler) HandleLog(ctx context.Context, instances []*istio_mixer_template_log.Instance) error {
	h.data.HandleLogCount++
	if h.behavior.HandleLogPanic {
		panic("HandleLog")
	}

	h.data.HandleLogInstances = instances
	return h.behavior.HandleLogErr
}

// GetAdptInfoFn returns the infoFn for the Adapter.
func (s *Adapter) GetAdptInfoFn() adapter.InfoFn {
	return func() adapter.Info {
		return adapter.Info{
			Name:               s.Behavior.Name,
			Description:        "",
			SupportedTemplates: s.Behavior.Tmpls,
			NewBuilder: func() adapter.HandlerBuilder {
				return builder{
					behavior:        s.Behavior.Builder,
					data:            s.BuilderData,
					handlerBehavior: s.Behavior.Handler,
					handlerData:     s.HandlerData,
				}
			},
			DefaultConfig: &types.Empty{},
			Impl:          "ThisIsASpyAdapter",
		}
	}
}
